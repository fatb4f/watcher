#!/usr/bin/env python3
"""Append watcher alert rows for Codex-related events."""

from __future__ import annotations

import argparse
import json
import os
import time
import uuid
from pathlib import Path
from typing import Any


def main() -> int:
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument("--severity", default="info")
    parser.add_argument("--reason", default="")
    parser.add_argument(
        "--out",
        default="~/.local/state/codex/watcher/codex-alerts.jsonl",
        help="Output JSONL path",
    )
    args = parser.parse_args()

    raw_event = os.environ.get("WATCH_EVENT_JSON", "{}")
    topic = os.environ.get("WATCH_EVENT_TOPIC", "")
    profile = os.environ.get("WATCH_PROFILE", "")
    try:
        event: dict[str, Any] = json.loads(raw_event)
    except json.JSONDecodeError:
        event = {"raw": raw_event}

    out_path = Path(args.out).expanduser()
    out_path.parent.mkdir(parents=True, exist_ok=True)

    row = {
        "event_id": str(uuid.uuid4()),
        "ts": time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime()),
        "severity": args.severity,
        "reason": args.reason,
        "topic": topic,
        "profile": profile,
        "event": event,
    }
    with out_path.open("a", encoding="utf-8") as f:
        f.write(json.dumps(row, sort_keys=True) + "\n")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
